# configuration-files readme

## Outline
This folder is where we plan to store configuration files used to generate UCLH synthetic data. The software datafaker/sqlsynthgen can create initial versions of these config files by looking at a data extract. These initial versions of the config files contain the names of the tables and columns in the data extract. The files can then be modified through an interactive process where the user can choose how to populate the tables and columns in the synthetic data.

## Folder structure
This folder can contain folders for templates and projects.

## Configuration files
Each folder will contain these 3 configuration files generated by datafaker.

file | outline
------- | --------- 
src-stats.yaml | summary stats from the data used to generate some of the synthetic data, includes comments. The only file that contains data derived from the contents of our real data extracts and the primary one for review.
orm.yaml | column names & brief attributes e.g. numeric or dates 
config.yaml | more detailed configurations used to generate the synthetic data

## A brief first example
Here is a very simple example to help explain what the configuration files contain.

The example creates the following two tables with just two columns each. The tables are part of the OMOP Common Data Model but would usually have more columns.

table to create | columns in the table
------- | --------- 
person | person_id, year_of_birth
death | person_id, death_date

`person_id` is what is called a database key, i.e. it links records for the same person in different tables. `person_id` is NOT an identifier like an NHS number or hospital number that is unique to a particular individual. `person_id` is simply a sequence that goes from 1 to the number of people in a data extract. Each time that we regenerate a data extract `person_id` will change. Similarly, other `*_id` variables do not uniquely refer to particular things that happened in the hospital.  

### configuration files for the first example

#### src-stats.yaml
Summary stats for source data columns depending on data type and options chosen for synthetic generation.

In this case shows that there are only 3 unique values for `death_date` in the source data and only one for `year_of_birth`. The one for `year_of_birth` is because the dates in UCLH OMOP extracts are shifted to be all relative to birth in 1970 to reduce risk of patient identification.

```
auto__death__death_date:
  comments:
  - All the values that appear in column death_date of table death
  queries:
    date: '2025-06-04 22:00:27'
    query: SELECT death_date AS value FROM death GROUP BY value ORDER BY COUNT(death_date)
      DESC
  results:
  - value: 1985-03-07
  - value: 1970-04-11
  - value: 1984-07-08
auto__person__year_of_birth:
  comments:
  - All the values that appear in column year_of_birth of table person
  queries:
    date: '2025-06-04 22:00:27'
    query: SELECT year_of_birth AS value FROM person GROUP BY value ORDER BY COUNT(year_of_birth)
      DESC
  results:
  - value: 1970
``` 
 
#### orm.yaml  

Shows the table and column names and what types of data they contain. The part that mentions `unique` ensures that the synthetic data does not contain people who have died more than once.

```
dsn: [database information]
schema: [database information]
tables:
  death:
    columns:
      death_date:
        nullable: false
        primary: false
        type: DATE
      person_id:
        nullable: false
        primary: false
        foreign_keys:
          - person.person_id        
        type: INTEGER
    unique:
      - name: unique_person
        columns: 
          - person_id        
  person:
    columns:
      person_id:
        nullable: false
        primary: true
        type: INTEGER
      year_of_birth:
        nullable: false
        primary: false
        type: INTEGER
    unique: []
```  
  
#### config.yaml
The first part indicated by`src-stats:` creates the file `src-stats.yaml` shown above. 

The second part starting `tables:` is used to create the rows and columns in the synthetic tables.

In this example the synthetic data for the two columns that are not database keys (`year_of_birth` and `death_date`) are randomly chosen from the values in the source data. This is indicated by `dist_gen.choice`.

`num_rows_per_pass:` is set higher for the `person` than `death` tables so that not all of the patients in the synthetic data are marked as having died.

```
src-stats:
- comments:
  - All the values that appear in column death_date of table death
  name: auto__death__death_date
  query: SELECT death_date AS value FROM death GROUP BY value ORDER BY COUNT(death_date)
    DESC
- comments:
  - All the values that appear in column year_of_birth of table person
  name: auto__person__year_of_birth
  query: SELECT year_of_birth AS value FROM person GROUP BY value ORDER BY COUNT(year_of_birth)
    DESC
tables:
  death:
    num_rows_per_pass: 3
    row_generators:
    - columns_assigned:
      - death_date
      kwargs:
        a: SRC_STATS["auto__death__death_date"]["results"]
      name: dist_gen.choice
  person:
    num_rows_per_pass: 10
    row_generators:
    - columns_assigned:
      - year_of_birth
      kwargs:
        a: SRC_STATS["auto__person__year_of_birth"]["results"]
      name: dist_gen.choice
```
